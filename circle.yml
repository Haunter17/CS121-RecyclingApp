# Continuous integration configuration file
# using CircleCI

general:
  branches:
    only:
     - master

machine:
  python:
    version: 2.7.11
  ruby:
    version: 2.4.0
  services:
    - docker
    - mysql

dependencies:
  pre:
    - pip install awscli
  override:
    - docker info
    # Build the image first so we don't have a copy of the precompiled assets in the image
    - docker build -t zhzhang2012/cs121-recycling-server-prod:$CIRCLE_SHA1 ./recycling-server
  post:
    # Mount the /public folder so we have a copy afterwards with the precompiled assets
    - docker run --rm --net=host -e RAILS_ENV=production -v $(pwd)/public:/srv/server/public zhzhang2012/cs121-recycling-server-prod:$CIRCLE_SHA1 bin/rails assets:precompile

database:
  pre:
    # Build test DB
    - docker run --rm --net=host -e RAILS_ENV=test zhzhang2012/cs121-recycling-server-prod:$CIRCLE_SHA1 /bin/bash -c "rake db:migrate; rake db:seed"

test:
  override:
    # TODO: Fix test environment MySQL
    - docker run --rm --net=host -e RAILS_ENV=test zhzhang2012/cs121-recycling-server-prod:$CIRCLE_SHA1 bin/rails test
  post:
    - docker run -d -p 3000:3000 --name recycling-test --net=host -e RAILS_ENV=test zhzhang2012/cs121-recycling-server-prod:$CIRCLE_SHA1; sleep 10
    - docker logs recycling-test
    - curl --retry 10 --retry-delay 5 -v http://localhost:3000
    - docker stop recycling-test

deployment:
  elasticbeanstalk:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - ./ci/deploy.sh $CIRCLE_SHA1
