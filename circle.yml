# Continuous integration configuration file
# using CircleCI

general:
  branches:
    only:
     - master

machine:
  python:
    version: 2.7.11
  ruby:
    version: 2.4.0
  services:
    - docker
    - mysql

dependencies:
  pre:
    - pip install awscli
  override:
    - docker info
  post:
    - docker build -t zhzhang2012/cs121-recycling-server-prod:$CIRCLE_SHA1 ./recycling-server

# TODO: Fix test environment MySQL
#test:
#  override:
#    - docker run --rm -e RAILS_ENV=test --net=host zhzhang2012/cs121-recycling-server-prod:$CIRCLE_SHA1 bin/rails test

deployment:
  elasticbeanstalk:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - ./ci/deploy.sh $CIRCLE_SHA1
